@page "/home"
@inject NavigationManager navi
@inject HttpClient client
@inject LocalStorageService localService

<style>
    .valid.modified:not([type=checkbox]) {
    outline: 1px solid #26b050;
    }

    .invalid {
    outline: 1px solid red;
    }

    .validation-message {
    color: red;
    }
</style>

<PageTitle >Home</PageTitle>
<h1 class="text-center m-5 custom-text" id="titulo"> SOLICITUD DE SALIDA DE BIENES </h1>
<div class="container row w-100">
    <div class="mb-3 custom-text col-3">
        <h5 for="Nombre" class="form-label m-2">Nombre: @nombreUsuario</h5>
        <h5 class="label label-default m-2">Fecha actual: @fechaFormateada</h5>
        <h5 class="label label-default m-2">Hora actual: @horaFormateada</h5>
    </div>
    <div class="col-9">
        <TablaProductos AddActivo="OnShowModalClick" />
    </div>
</div>
<!--
<div class="mb-3 w-50 mx-auto text-center custom-text">
<Button Color="ButtonColor.Danger" @onclick="OnShowModalClick" Outline="true" Class="shadow-lg">Registrar bien a salir</Button>
</div>
-->
<h3 class="m-5 custom-text">Activos solicitados a salir</h3>
<TablaSolicitud @ref="@tablaSolicitud"/>
<Button  Color="ButtonColor.Success" @onclick="@InsertarBienes">
    Enviar Solicitud
</Button>

@if (!string.IsNullOrEmpty(RawJson))
{
    <h4>@RawJson</h4>
}

<Modal @ref="modal" Title="Registrar bien a salir" UseStaticBackdrop="true" BodyCssClass="p-0" CloseOnEscape="false">
    <BodyTemplate>

        <EditForm EditContext="@editContext" OnValidSubmit="ValidateForm">
            <DataAnnotationsValidator />

            <div class="mb-3 w-100 custom-text" style="background-color:#e3e3e3; padding:1rem;">
                <div class="w-75 mx-auto">
                    <label class="form-label">Área <span class="text-danger">*</span></label>
                    <TextInput @bind-Value="@solicitud.Area" Style="text-transform: uppercase"/>
                    <ValidationMessage For="@(() => solicitud.Area)" />

                    <label class="form-label">Encargado de Área <span class="text-danger">*</span></label>
                    <TextInput @bind-Value="@solicitud.EncargadoArea" Style="text-transform: uppercase" />
                    <ValidationMessage For="@(()=>solicitud.EncargadoArea)"/>

                    <label class="form-label">No.</label>
                    <NumberInput @bind-Value="@contNo" Disabled="true"/>

                    <label class="form-label">No. de Inventario</label>
                    <NumberInput @bind-Value="@solicitud.NumeroInventario" Disabled="true"/>

                    <label class="form-label">Descripcion</label>
                    <TextAreaInput @bind-Value="@solicitud.Descripcion" Disabled="true" />

                    <label class="form-label">Motivo de salida <span class="text-danger">*</span></label>
                    <TextAreaInput @bind-Value="@solicitud.MotivoSalida" Style="text-transform: uppercase" />
                    <ValidationMessage For="@(() => solicitud.MotivoSalida)" />

                    <label class="form-label">Observaciones<span class="text-danger">*</span></label>
                    <TextAreaInput @bind-Value="@solicitud.Observaciones" Style="text-transform: uppercase" />
                    <ValidationMessage For="@(() => solicitud.Observaciones)" />
                </div>
            </div>
        </EditForm>

        <div class="toast-container position-fixed bottom-0 end-0 p-3 ">
            <div class="toast show text-bg-danger" role="alert" aria-live="assertive" aria-atomic="true" style="display:@(showToast ? "block" : "none")">
                <div class="toast-body">
                    @mensaje
                </div>
            </div>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Type="ButtonType.Submit" Color="ButtonColor.Success" @onclick="ValidateForm">Enviar</Button>
    </FooterTemplate>
</Modal >

<Modal @ref="serviceModal">
    <BodyTemplate>
        @mensaje
    </BodyTemplate>   
</Modal>


@code {

    private Modal serviceModal { set; get; } = default!;
    //Este es para una carga     
    //Carag para evitar que el usuario haga alguna accion de mas
    [Inject] protected PreloadService PreloadService { get; set; } = default!;



    public string status = "Salida", fechaFormateada = "", horaFormateada = "", mensaje;
    public string? nombreUsuario { get; set; }
    public string? FyH { get; set; }
    private Modal modal = default!;
    private SolicitudBien solicitud = new();
    private EditContext? editContext;
    public int contNo = 1;
    private System.Timers.Timer? timer;
    private bool showToast = false;
    public List<Usuarios>? listaUsua = new();
    public Producto? producto = new();
    private TablaSolicitud tablaSolicitud = default!;
    public string? RawJson { get; set; }

    private async Task setInventario(ChangeEventArgs arg)
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, $"https://sistemas.dif.hidalgo.gob.mx/WebServicesARM/ActivoFijo/api/Bienes/consulta?bienID={arg.Value.ToString()}&pagina=1");
        var response = await client.SendAsync(request);
        response.EnsureSuccessStatusCode();
        var text = await response.Content.ReadAsStringAsync();
        Console.WriteLine(text);
        var paginado = JsonConvert.DeserializeObject<Paginado>(text);
        solicitud.Descripcion = paginado.registros[0].descripcion;
        solicitud.NumeroInventario = paginado.registros[0].bienID;

        Console.WriteLine(arg.Value.ToString());
    }

    protected override async Task OnInitializedAsync()
    {

        UpdateTime();
        StartTimer();
        editContext = new EditContext(solicitud);
    }

    private void StartTimer()
    {
        timer = new System.Timers.Timer(1000); // Ejecutar cada 1 segundo
        timer.Elapsed += (sender, e) => UpdateTime();
        timer.AutoReset = true;
        timer.Enabled = true;
    }

    private void UpdateTime()
    {
        DateTime fechaActual = DateTime.Now;
        fechaFormateada = fechaActual.ToString("dd/MM/yyyy");
        horaFormateada = fechaActual.ToString("HH:mm:ss");
        FyH = fechaFormateada + " " + horaFormateada;

        InvokeAsync(StateHasChanged); // Forzar actualización en la UI
    }

    private async Task OnShowModalClick(Producto producto)
    {
        solicitud.Descripcion = producto.descripcion;
        solicitud.NumeroInventario = producto.bienID;

        await modal.ShowAsync();
    }

    private async Task ValidateForm()
    {
        if (!editContext.Validate())
        {
            mensaje = "Algunos campos obligatorios están vacíos. Por favor, complétalos.";
            showToast = true;
            StateHasChanged();
            await Task.Delay(3000);
            showToast = false;
            StateHasChanged();
            return;
        }

        var existe = tablaSolicitud.solicitudes.Any(s =>
            s.NumeroInventario == solicitud.NumeroInventario &&
            s.Fecha == DateTime.Today.ToString("dd/MM/yyyy"));

        if (existe)
        {
            mensaje = "Activo ya solicitado para su salida.";
            showToast = true;
            Console.WriteLine("Ya se ha registrado este artículo hoy.");
            return;
        }

        solicitud.Fecha = DateTime.Today.ToString("dd/MM/yyyy");
        await tablaSolicitud.AddSolicitud(solicitud);
        solicitud = new SolicitudBien();
        editContext = new EditContext(solicitud);
        contNo++;
        await modal.HideAsync();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            await localService.InitializeAsync();
            nombreUsuario = await localService.GetItemAsync("userBienes");
        }
    }
    public async Task ImprimirActivos()
    {
        var texto = JsonConvert.SerializeObject(tablaSolicitud.solicitudes);
        Console.WriteLine(texto);
    }
    private async Task InsertarBienes()
    {
        //await ModalShow(ModalType.Danger,"Error","ErroR al insertar un articulo");
        Console.WriteLine("Insetento de envio ");
        try
        {
            PreloadService.Show(SpinnerColor.Danger);
            //Modelo que se enviara al server para que haga el registro de los articulos
            InsertSolicitud solic = new InsertSolicitud();
            //Creamos una nueva lista, recordemos que le haen falta algunos datos
            List<SolicitudBien> insertDatos = new();
            //Iteramos los articulos para añadir los datos por llenar
            foreach (var item in tablaSolicitud.solicitudes)
            {
                item.Nombre = nombreUsuario;
                item.Fecha = FyH;
                item.Numero = contNo;//Aqui añadiremos el contadoe cada que se alada
                //Añadimos los elementos con los nuevos datos
                insertDatos.Add(item);
            }
            //Le asignamos el valor de la nueva lista al modelo que enviaremos
            solic.activos = insertDatos;
            //Obtenemos el id del usuario que recordemos lo guardamos en el local Storage del navegador y le asignamos el nuevo valor al modelos que le enviaremos al server
            var userId = int.Parse(await localService.GetItemAsync("idUserBienes") ?? "0");
            solic.idUser = userId;

            //Recordemos que el servidor no reconoce objetos en automatico
            //Lo hace a travez de texto en formato de JSON

            var clientt = new HttpClient();
            //Creamos la peticion, que es una peticion ???
            var request = new HttpRequestMessage(HttpMethod.Post, "http://172.16.9.10/ControlSalidaBienes/api/activo");//Recordemos que el metodo para enviar datos es con POST
            //Convertiremos nuestro modelo a enviar en un json , con este comando crearemos un json, desde el modelo
            var rawJson = JsonConvert.SerializeObject(solic);
            var content = new StringContent(rawJson, null, "application/json");//Es lo que le enviaremos al server
            //Le asigamos los valores a enviar en la peticion
            request.Content = content;
            //Le aremos el envio de los datos al server
            var response = await clientt.SendAsync(request);
            //Esta fucion lanza un error en caso de que la respuesta sea diferente a 200
            Console.WriteLine(await response.Content.ReadAsStringAsync());
            if (response.StatusCode != System.Net.HttpStatusCode.OK)
            {
                //Aqui obtenemos la respuesta del servidor en textto que en realidad es texto plano en formato JSON
                var mensaje = await response.Content.ReadAsStringAsync();
                //ya que que no hay una estrucutura definida para recibir errores yo cree una que podra servir para otras cosas

                //Aqui entra lo que te comentaba, ahora necesitamos recibir la reouesta de un servidor,
                //recuerda cielo que es un json, que tenemos que convertir en un objeto(modelo)
                var respuesta = JsonConvert.DeserializeObject<ResponseApi>(mensaje);
                mensaje = respuesta.response.ToString();
                //await ModalShow(ModalType.Danger, "Algo salio mal!", respuesta.response.ToString());
                serviceModal.Title = "Solicitud rechazada:";
                mensaje = "El artículo ya fue solicitado previamente.";
                serviceModal.HeaderCssClass = "bg-danger text-light";

                PreloadService.Hide();
                StateHasChanged();
                await serviceModal.ShowAsync();
                return;
            }
            serviceModal.Title = "Solicitud correcta:";
            mensaje = "La solicitud ha sido registrada exitosamente.";
            serviceModal.HeaderCssClass = "bg-succes";
            PreloadService.Hide();
            await serviceModal.ShowAsync();
            await Task.Delay(2000);
            await serviceModal.HideAsync();
            navi.NavigateTo(navi.Uri, forceLoad: true);
        }
        catch (Exception ex)
        {
            PreloadService.Hide();
        }
    }
   
}