@page "/home"

@inject LocalStorageService localService
<style>
    .valid.modified:not([type=checkbox]) {
        outline: 1px solid #26b050;
    }

    .invalid {
        outline: 1px solid red;
    }

    .validation-message {
        color: red;
    }
</style>

<PageTitle>Home</PageTitle>
<h1 class="text-center m-5 custom-text"> SOLICITUD DE SALIDA DE BIENES </h1>
<div class="container row w-100">
    <div class="mb-3 custom-text col-3">
        <h5 for="Nombre" class="form-label m-2">Nombre: @nombreUsuario</h5>
        <h5 class="label label-default m-2">Fecha actual: @fechaFormateada</h5>
        <h5 class="label label-default m-2">Hora actual: @horaFormateada</h5>
    </div>
    <div class="col-9">
        <TablaProductos AddActivo="OnShowModalClick" />
    </div>
</div>
<!--
<div class="mb-3 w-50 mx-auto text-center custom-text">
<Button Color="ButtonColor.Danger" @onclick="OnShowModalClick" Outline="true" Class="shadow-lg">Registrar bien a salir</Button>
</div>
-->
<h3 class="m-5 custom-text">Activos solicitados a salir</h3>
<TablaSolicitud @ref="@tablaSolicitud"/>
<Modal @ref="modal" Title="Registrar bien a salir" UseStaticBackdrop="true" BodyCssClass="p-0" CloseOnEscape="false">
    <BodyTemplate>
        
        <EditForm EditContext="@editContext" OnValidSubmit="ValidateForm">
            <DataAnnotationsValidator />

            <div class="mb-3 w-100 custom-text" style="background-color:#e3e3e3; padding:1rem;">
                <div class="w-75 mx-auto">
                    <label class="form-label">Área <span class="text-danger">*</span></label>
                    <TextInput @bind-Value="@solicitud.Area" Style="text-transform: uppercase"/>
                    <ValidationMessage For="@(() => solicitud.Area)" />

                   <label class="form-label">Encargado de Área <span class="text-danger">*</span></label>
                    <TextInput @bind-Value="@solicitud.EncargadoArea" Style="text-transform: uppercase" />
                    <ValidationMessage For="@(()=>solicitud.EncargadoArea)"/>

                    <label class="form-label">No.</label>
                    <NumberInput @bind-Value="@contNo" Disabled="true"/>

                    <label class="form-label">No. de Inventario</label>
                    <NumberInput @bind-Value="@solicitud.NumeroInventario" Disabled="true"/>

                    <label class="form-label">Descripcion</label>
                    <TextAreaInput @bind-Value="@solicitud.Descripcion" Disabled="true" />

                    <label class="form-label">Motivo de salida <span class="text-danger">*</span></label>
                    <TextAreaInput @bind-Value="@solicitud.MotivoSalida" Style="text-transform: uppercase" />
                    <ValidationMessage For="@(() => solicitud.MotivoSalida)" />

                    <label class="form-label">Observaciones<span class="text-danger">*</span></label>
                    <TextAreaInput @bind-Value="@solicitud.Observaciones" Style="text-transform: uppercase" />
                    <ValidationMessage For="@(() => solicitud.Observaciones)" />
                </div>
            </div>
        </EditForm>
        
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div class="toast show text-bg-danger" role="alert" aria-live="assertive" aria-atomic="true" style="display:@(showToast ? "block" : "none")">
                <div class="toast-body">
                    Algunos campos obligatorios están vacíos. Por favor, complétalos.
                </div>
            </div>
        </div>
       

    </BodyTemplate>
    <FooterTemplate>
        <Button Type="ButtonType.Submit" Color="ButtonColor.Success" @onclick="ValidateForm">Enviar</Button>
    </FooterTemplate>
</Modal>

@code {

    public string nombreUsuario = "";
    private Modal modal = default!;
    private SolicitudBien solicitud = new();
    private EditContext? editContext;
    private string fechaFormateada = "", horaFormateada = "", fyh;
    private int contNo = 1;
    private System.Timers.Timer? timer;
    private bool showToast = false;
    public List<Usuarios>? listaUsua = new();
    public Producto? producto = new();


    private TablaSolicitud tablaSolicitud = default!;

    private async Task setInventario(ChangeEventArgs arg)
    {
        var client = new HttpClient();
        var request = new HttpRequestMessage(HttpMethod.Get, $"http://172.16.2.28/WebServicesARM/ActivoFijo/api/Bienes/consulta?bienID={arg.Value.ToString()}&pagina=1");
        var response = await client.SendAsync(request);
        response.EnsureSuccessStatusCode();
        var text = await response.Content.ReadAsStringAsync();
        Console.WriteLine(text);
        var paginado = JsonConvert.DeserializeObject<Paginado>(text);
        solicitud.Descripcion = paginado.registros[0].descripcion;
        solicitud.NumeroInventario = paginado.registros[0].bienID;

        Console.WriteLine(arg.Value.ToString());
    }

    protected override async Task OnInitializedAsync()
    {
        //listaUsua = await ConexionBase.ObtenerUsuarios();

        UpdateTime();
        StartTimer();

        DateTime fechaActual = DateTime.Now;
        fechaFormateada = fechaActual.ToString("dd/MM/yyyy");
        horaFormateada = fechaActual.ToString("HH:mm:ss");
        fyh = fechaFormateada + " " + horaFormateada;

        editContext = new EditContext(solicitud);
    }


    private void StartTimer()
    {
        timer = new System.Timers.Timer(1000); // Ejecutar cada 1 segundo
        timer.Elapsed += (sender, e) => UpdateTime();
        timer.AutoReset = true;
        timer.Enabled = true;
    }

    private void UpdateTime()
    {
        DateTime fechaActual = DateTime.Now;
        fechaFormateada = fechaActual.ToString("dd/MM/yyyy");
        horaFormateada = fechaActual.ToString("HH:mm:ss");

        InvokeAsync(StateHasChanged); // Forzar actualización en la UI
    }

    private async Task OnShowModalClick(Producto producto)
    {

        solicitud.Descripcion = producto.descripcion;
        solicitud.NumeroInventario = producto.bienID;
        solicitud.producto = producto;
        await modal.ShowAsync();
    }



    private async Task ValidateForm()
    {
        if (!editContext.Validate())
        {
            showToast = true;
            StateHasChanged();
            await Task.Delay(3000);
            showToast = false;
            StateHasChanged();
        }
        else
        {

            tablaSolicitud.AddSolicitud(solicitud);

            // ✅ Mantener la lógica original
            solicitud = new SolicitudBien();
            editContext = new EditContext(solicitud);
            contNo++;
            await modal.HideAsync();
            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            await localService.InitializeAsync();
            nombreUsuario = await localService.GetItemAsync("userBienes");
        }
    }

}